#!/usr/bin/env bash

set -eEuo pipefail

#####################
# Functions for MacOS
#####################
{{ if eq .chezmoi.os "darwin" }}

######
# Brew
######
chmod g-w,o-w /opt/homebrew/share

##########################
# Use Zsh as default shell
##########################
ZSH_PATH=$(which zsh)
if grep --fixed-strings --line-regexp --quiet $ZSH_PATH /etc/shells
then
    echo "No need to add $ZSH_PATH into /etc/shells"
else
    echo "Adding $ZSH_PATH into /etc/shells"
    sudo sh -c "echo $(which zsh) >> /etc/shells"
fi
# chsh -s $(which zsh)

########################################
# Configure GitHub Cli to clone with SSH
########################################
gh config set git_protocol ssh

###############################
# Install Python latest version
#   Install Python global modules requirements hash: {{ include ".files/requirements.txt" | sha256sum }}
###############################
pyenv install --skip-existing 3
pyenv global $(pyenv latest 3)
pip install --upgrade pip
pip install --requirement {{ joinPath .chezmoi.sourceDir ".files/requirements.txt" | quote }}

#############################
# Install Ruby latest version
#############################
LATEST_RUBY_VERSION=$(curl --silent https://api.github.com/repos/ruby/ruby/releases/latest | jq -r '.name')
rbenv install --skip-existing $LATEST_RUBY_VERSION
rbenv global $LATEST_RUBY_VERSION

##################################
# Kubernetes related configuration
##################################
[[ {{ joinPath .chezmoi.homeDir ".rd/bin/kubectl" }} ]] && source <(kubectl completion zsh)

{{ end }}
