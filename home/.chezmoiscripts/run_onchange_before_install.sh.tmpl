# Copyright [2023] Julian Nonino
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

################################
# Detect the type of Unix system
################################
{{- $osid := .chezmoi.os -}}
{{- if hasKey .chezmoi.osRelease "id" -}}
{{-   $osid = printf "%s-%s" .chezmoi.os .chezmoi.osRelease.id -}}
{{- end -}}

[data]
    osid = {{ $osid | quote }}

############################
# Script init and OS Upgrade
############################
{{ if (or (eq .osid "darwin") (.osid | lower | contains "linux")) }}
#!/usr/bin/env bash

set -eEuo pipefail

{{   if eq .osid "linux-debian" }}
        sudo apt-get update -y
        sudo DEBIAN_FRONTEND=noninteractive apt-get upgrade -yq
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -yq build-essential procps curl file git
{{   else if eq .osid "linux-fedora" }}
        sudo dnf -y update
        sudo dnf -y upgrade
        sudo dnf -y install @development-tools procps-ng curl file git
{{   end }}

{{ end }}

#####################################
# Install brew if it is not installed
#####################################
if ! command -v brew &> /dev/null
then
  echo "brew is not installed"
  bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

{{ if eq .chezmoi.os "linux" }}
  test -d ~/.linuxbrew && eval "$(~/.linuxbrew/bin/brew shellenv)"
  test -d /home/linuxbrew/.linuxbrew && eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
{{ end }}

export HOMEBREW_PREFIX=$(brew --prefix)
eval "$($HOMEBREW_PREFIX/bin/brew shellenv)"

{{ if eq .chezmoi.os "linux" }}
  brew install gcc
{{ end }}

###################
# Brew dependencies
#   Install packages
#   Brewfile hash: {{ include ".files/Brewfile" | sha256sum }}
###################
brew update
brew bundle --verbose --debug --file {{ joinPath .chezmoi.sourceDir ".files/Brewfile" | quote }}
brew upgrade
brew autoremove
brew cleanup

#######################################
# Install oh-my-zsh - https://ohmyz.sh/
#######################################
if [ -d {{ joinPath .chezmoi.homeDir ".oh-my-zsh" }} ]; then
  echo "oh-my-zsh is installed"
else
  echo "oh-my-zsh is not installed"
  sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
fi

#########################
# Node Version Management
#########################
mkdir -p {{ joinPath .chezmoi.homeDir ".nvm" }}

#########################
# Ruby Version Management
#########################
mkdir -p {{ joinPath .chezmoi.homeDir ".rbenv" }}

########################
# WSL Specific Functions
########################
{{ if (and (eq .chezmoi.os "linux") (.chezmoi.kernel.osrelease | lower | contains "microsoft")) }}
{{ end }}

{{ end }}
