# Copyright [2023] Julian Nonino
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

{{ if or
      (eq .chezmoi.os "darwin")
      (eq .chezmoi.os "linux")
      (and (eq .chezmoi.os "linux") (contains (lower .chezmoi.kernel.osrelease) "microsoft"))
    }}
#!/usr/bin/env bash
set -eEuo pipefail

###### Homebrew permissions ######
chmod g-w,o-w "$HOMEBREW_PREFIX/share"

##############################
# Use Zsh as default shell on macOS
##############################
{{- if eq .chezmoi.os "darwin" -}}
ZSH_PATH=$(which zsh)
if ! grep -Fxq "$ZSH_PATH" /etc/shells; then
  echo "Adding $ZSH_PATH to /etc/shells"
  sudo sh -c "echo $ZSH_PATH >> /etc/shells"
fi
# Optionally: chsh -s "$ZSH_PATH"
{{- end }}

########################################
# GitHub CLI: prefer SSH cloning
########################################
gh config set git_protocol ssh || true

########################################
# Manage latest runtime versions
########################################

# Python via pyenv
pyenv install --skip-existing 3 || true
pyenv global $(pyenv latest 3)
pip install --upgrade pip
pip install --no-input --requirement {{ joinPath .chezmoi.sourceDir ".files/requirements.txt" | quote }}

# Ruby via rbenv
LATEST_RUBY=$(curl --silent https://api.github.com/repos/ruby/ruby/releases/latest | jq -r '.tag_name')
rbenv install --skip-existing "$LATEST_RUBY" || true
rbenv global "$LATEST_RUBY"

# Go via goenv
GOLANG_LATEST=$(goenv install --list | sort --version-sort --reverse | head -n1 | xargs)
goenv install --skip-existing "$GOLANG_LATEST" || true
goenv global "$GOLANG_LATEST"

# Node LTS via nvm
nvm install --lts --default

##################################
# iTerm2 profile on macOS
##################################
{{- if eq .chezmoi.os "darwin" -}}
mkdir -p "$HOME/Library/Application Support/iTerm2/DynamicProfiles"
cp {{ joinPath .chezmoi.sourceDir ".files/iterm/Main.json" | quote }} \
   "$HOME/Library/Application Support/iTerm2/DynamicProfiles/"
defaults write com.googlecode.iterm2 "Default Bookmark Guid" \
  -string "F06B6A79-D0FA-4825-BF71-F2D3B153CCE3"
{{- end }}

##################################
# Custom functions
##################################
if [ -f "{{ joinPath .chezmoi.homeDir ".config/functions.sh" }}" ]; then
  source "{{ joinPath .chezmoi.homeDir ".config/functions.sh" }}"
fi

##########################################
# (Optional) WSL-specific tweaks
##########################################
{{- if and (eq .chezmoi.os "linux")
           (lower .chezmoi.kernel.osrelease | contains "microsoft")) -}}
# Add WSL-specific config here
{{- end }}

{{- end -}}
